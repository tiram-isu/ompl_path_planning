# Motion Planning using 3D Gaussian Splatting
This repository contains the functionalities for motion planning using 3D Gaussian Splatting (3DGS) scenes as a scene representation for collision detection. 
The 3DGS scene is first converted into a voxel grid by dividing the scene into voxel cubes of a specified size. Then, for each of these voxels it is checked whether it contains at least one 3D Gaussian. If so, the voxel is marked as occupied.

Path Planning is done using the Open Motion Planning Library (OMPL). The voxel grid representation of the 3DGS scene is used for collision checking, ensuring that generated paths don't collide with any obstacles.
Additionally, a maximum distance from the ground where paths are allowed can be specified to ensure the path stays at a realistic distance to the ground.

After a path has been generated, it is smoothed to remove sharp corners. Then, camera orientation is added to the coordinates and the path converted to Nerfstudio format and saved as a .json file.
Optionally, this can then be sent to be rendered by Nerfstudio via a Flask server.

# Features
- Conversion of 3DGS scenes into a voxel grid
- Motion Planning using OMPL
- Path visualization using Open3D, data visualization using Matplotlib
- [optionally] rendering using Nerfstudio

# Prerequisites
- Docker and WSL 2
[optionally for rendering]
- Conda
- Nerfstudio

# Installation
- build Docker file included in "setup" folder

# Usage
The following parameters need to be set in the main.py script:
1. Set information about the 3DGS scene to be used
   - Specify the name of the .ply or .ckpt file containing the 3DGS scene to be used as a scene representation. Only .ckpt files generated by Nerfstudio are supported.
   - Set the name of the output folder where results are saved.
   - [Optionally]: Specify the path to a mesh to be used for visualization. If no path is given, the generated voxel representation will be used for visualizing the resulting paths.
2. Configure the voxel grid
   - Filtering Gaussians: Opacity and scale thresholds can be set to filter out Gaussians during voxel grid creation. 
   - Voxel resolution: Either a manual voxel resolution (number of voxels per largest axis) or a voxel resolution factor need to be specified.\\
     If no manual voxel resolution is given, the system uses calculates the voxel size by dividing the average size of the Gaussians by this factor, meaning the smaller the factor, the bigger the voxels.
   - The scale factor is needed because different implementations of 3DGS use different scales. For files created by Nerfstudio, this value should be 0.001, for files created by the original 3DGS implementation or Hierarchical 3DGS, it should be 0.1.
   - Padding is the number of neighbors next to an occupied voxel that are marked as occupied as well to ensure the path won't go through small gaps between Gaussians. Support voxels are the number of voxels above ground that are acceptable for the path to travel through.
   - Finally, specify whether the voxel grid creation should be logged.
   The resulting voxel grid is saved under "voxel_models>output_name>resolution". Here, the log and mesh created from the voxel grid for vizualization purposes are also saved. Within this folder, the voxel grid with padding and ground constraints is saved in a folder named correspondingly.
   When starting the code, the system first checks if a voxel grid with these settings already exists by checking the corresponding folder. If it does, it is loaded for path generation. If it doesn't, it is generated and saved for further path generation processes.
3. Configure the planning algorithms
  - Choose the planning algorithms to be used. This can be a single algorithm or multiple that are then executed in parallel using multiple processes.
  - Also choose the planner range and state validity resolution.
4. Path settings
  - Specify the pairs of start and end coordinates between which a path should be found. By adding multiple coordinate pairs to the list, the system will search paths for each pair.
  - Specify the number of paths to be generated for each planning algorithm and coordinate pair.
  - Also specify the maximum time allowed for searching one path in seconds as well as the number of smoothing steps (higher = smoother paths).
5. Debugging settings
  - Enable interactive visualization: After one process has finished planning paths for one algorithm and number of paths, an interactive Open3D window opens to show the generated paths. For this, either the custom visualization mesh is used or the generated voxel grid mesh.
  - Save screenshot: Whether to save a screenshot of this visualization. The screenshot can also be saved without showing the window.
  - Enable logging: When logging is enabled, the path planning process is logged for each planner and number of paths including information about the generated paths.
  - Render Nerfstudio video: Whether the generated camera paths should be sent via Flask to be rendered by Nerfstudio. This requires a conda environment with Nerfstudio installed and the Flask server running.
6. [optional] Nerfstudio paths. These are only required when Nerfstudio rendering is enabled.
  - Nerfstudio base directory: The base directory containing all files related to the Nerfstudio 3DGS scene.
  - Checkpoint path: The path pointing to the Nerfstudio .yml file corresponding to the 3DGS scene relative to the base directory.
  - Paths directory: The directory in WSL where the Python scripts are located.
  - Output directory: Directory where the resulting videos are saved relative to the base directory.

After setting these parameters, the script can be executed.
Logging information is saved in the output>output_name folder, creating a subdirectory for each number of paths that were generated. Here, the logs and saved screenshots are saved for each planner.
In addition, a summary log containing the most important statistics about all planners is created.
Plots depicting the information about computation times, path lengths and path curvatures for all planners are saved in the plots folder.

# File structure
```bash
\\wsl.localhost\Ubuntu.
├───models
├───voxel_models
│   ├───<output_name>
│   │   └───res_factor<voxel_resolution>
│   │       └───voxels_<opacity_threshold>_<size_threshold>
├───output
│   ├───<output_name>
│   │   └───<num_paths>
├───paths
│   main.py
│   importer.py
│   gaussians_to_voxels.py
│   voxel_grid.py
│   collision_detection.py
│   planner_manager.py
│   planner.py
│   visualization.py
│   path_utils.py
│   log_utils.py
```
